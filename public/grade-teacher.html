<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª - Ù…Ø¯Ø±Ø³ØªÙ†Ø§ Ø§Ù„Ù…Ø±Ø­Ø©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.16/dist/sweetalert2.all.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Amiri:wght@700&display=swap');

    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f4f8;
    }

    .sidebar {
      background: linear-gradient(135deg, #1e3a8a, #374151);
      min-height: 100vh;
      width: 250px;
      transition: all 0.3s;
    }

    .filter-section {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .filter-section input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background-color: #f9fafb;
      font-size: 0.9rem;
      color: #374151;
      transition: border-color 0.2s ease;
    }

    .filter-section input:hover {
      border-color: #1e3a8a;
    }

    .filter-section input:focus {
      outline: none;
      border-color: #1e3a8a;
      box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.1);
    }

    table tbody tr {
      transition: background-color 0.2s ease;
    }

    table tbody tr:hover {
      background-color: #f9fafb;
    }
  </style>
</head>

<body>
  <div class="flex">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
    <aside class="sidebar fixed top-0 right-0">
      <div class="p-4">
        <div class="text-center mb-8">
          <img src="https://img.icons8.com/color/96/000000/open-book.png" class="w-16 mx-auto mb-2"
            alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" />
          <h2 class="text-white font-bold text-xl">Ù…Ø¯Ø±Ø³ØªÙ†Ø§ Ø§Ù„Ù…Ø±Ø­Ø©</h2>
        </div>
        <nav>
          <div id="teacherNav" class="space-y-2">
            <a href="dashboard.html"
              class="px-4 py-3 text-white hover:bg-blue-800 flex items-center gap-2 transition-all">
              <span>ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…
            </a>
            <a href="grade-teacher.html"
              class="px-4 py-3 text-white bg-blue-700 flex items-center gap-2 transition-all">
              <span>ğŸ“</span> Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
            </a>
            <a href="teacherAssignments.html"
              class="px-4 py-3 text-white hover:bg-blue-800 flex items-center gap-2 transition-all">
              <span>ğŸ“š</span> Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª
            </a>
            <a href="teacherAttendance.html"
              class="px-4 py-3 text-white hover:bg-blue-800 flex items-center gap-2 transition-all">
              <span>ğŸ“…</span> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
            </a>
            <a href="teacherProfile.html"
              class="px-4 py-3 text-white hover:bg-blue-800 flex items-center gap-2 transition-all">
              <span>ğŸ‘¤</span> Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ù„Ù…
            </a>
          </div>
        </nav>
      </div>
    </aside>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <main class="flex-1 mr-[250px] p-8">
      <header class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</h1>
          <p class="text-gray-600 p-4" id="welcomeMessage">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</p>
        </div>
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        </button>
      </header>

      <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª -->
      <div id="teacherGradesContent">
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 filter-section">
          <h2 class="text-xl font-bold mb-4 text-gray-800">Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-right">
              <thead>
                <tr class="bg-gray-100">
                  <th class="p-3 text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                  <th class="p-3 text-gray-700">Ø§Ø³Ù… Ø§Ù„ØµÙ</th>
                  <th class="p-3 text-gray-700">Ø§Ù„ÙØµÙ„</th>
                  <th class="p-3 text-gray-700">Ø§Ù„Ø³Ù†Ø©</th>
                </tr>
              </thead>
              <tbody id="sectionsList"></tbody>
            </table>
          </div>
        </div>
        <div id="subjectsSection" class="hidden bg-white p-6 rounded-xl shadow-lg mb-8 filter-section">
          <h2 class="text-xl font-bold mb-4 text-gray-800" id="subjectsTitle">Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="subjectsList"></div>
        </div>
        <div id="studentsSection" class="hidden bg-white p-6 rounded-xl shadow-lg filter-section">
          <h2 class="text-xl font-bold mb-4 text-gray-800" id="studentsTitle">Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
          <div class="overflow-x-auto">
            <table class="w-full text-right">
              <thead>
                <tr class="bg-gray-100">
                  <th class="p-3 text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th class="p-3 text-gray-700">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£ÙˆÙ„</th>
                  <th class="p-3 text-gray-700">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ</th>
                  <th class="p-3 text-gray-700">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø«Ø§Ù„Ø«</th>
                  <th class="p-3 text-gray-700">Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                  <th class="p-3 text-gray-700">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                  <th class="p-3 text-gray-700">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="studentsList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ† ÙÙŠ localStorage');
      window.location.href = 'login.html';
    } else {
      console.log('Token:', token);
    }

    let allSections = [];
    let allClasses = [];
    let allSemesters = [];
    let allAcademicYears = [];
    let allSubjects = [];
    let teacherSubjectSections = [];
    const terms = ['Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø«Ø§Ù„Ø«', 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ'];
    let editingRow = null;
    let originalGrades = {};

    async function fetchTeacherData() {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…...');
        const teacherResponse = await axios.get('http://localhost:3000/teacher/me', {
          headers: { Authorization: `${token}` }
        });
        console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…:', teacherResponse.data);

        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª TeacherSubjectSections...');
        const tssResponse = await axios.get('http://localhost:3000/teacherSubjectSections/mine/mine', {
          headers: { Authorization: `${token}` }
        });
        console.log('Ø¨ÙŠØ§Ù†Ø§Øª TeacherSubjectSections:', tssResponse.data);

        teacherSubjectSections = tssResponse.data;
        setupTeacherGrades(teacherResponse.data);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…:', error.response?.data || error.message);
        handleAuthError(error);
      }
    }

    async function fetchSections(sectionIds) {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨:', sectionIds);
        const response = await axios.get('http://localhost:3000/sections', {
          headers: { Authorization: `${token}` },
          params: { sectionIds: sectionIds.join(',') }
        });
        allSections = response.data.filter(section => {
          const sectionId = typeof section._id === 'object' ? section._id.toString() : section._id;
          return sectionIds.includes(sectionId);
        });
        console.log('Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©:', allSections);
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø¹Ø¨', confirmButtonColor: '#1e3a8a' });
      }
    }

    async function fetchClasses() {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙÙˆÙ...');
        const response = await axios.get('http://localhost:3000/classes', {
          headers: { Authorization: `${token}` }
        });
        allClasses = response.data;
        console.log('Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©:', allClasses);
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØµÙÙˆÙ:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ', confirmButtonColor: '#1e3a8a' });
      }
    }

    async function fetchSemesters() {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØµÙˆÙ„...');
        const response = await axios.get('http://localhost:3000/semesters', {
          headers: { Authorization: `${token}` }
        });
        allSemesters = response.data;
        console.log('Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©:', allSemesters);
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØµÙˆÙ„:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', confirmButtonColor: '#1e3a8a' });
      }
    }

    async function fetchAcademicYears() {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©...');
        const response = await axios.get('http://localhost:3000/academicYears', {
          headers: { Authorization: `${token}` }
        });
        allAcademicYears = response.data;
        console.log('Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©:', allAcademicYears);
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', confirmButtonColor: '#1e3a8a' });
      }
    }

    async function fetchSubjects() {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯...');
        const response = await axios.get('http://localhost:3000/subjects', {
          headers: { Authorization: `${token}` }
        });
        allSubjects = response.data;
        console.log('Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©:', allSubjects);
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¯:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯', confirmButtonColor: '#1e3a8a' });
      }
    }

    async function fetchStudentsBySection(sectionId, subjectId) {
      try {
        console.log(`Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionId} ÙˆØ§Ù„Ù…Ø§Ø¯Ø© ${subjectId}...`);
        const section = allSections.find(s => s._id === sectionId);
        const sectionName = section ? section.name : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        console.log(`Ø§Ø³Ù… Ø§Ù„Ø´Ø¹Ø¨Ø©: ${sectionName} (ID: ${sectionId})`);

        const studentsResponse = await axios.get(`http://localhost:3000/students?sectionId=${sectionId}`, {
          headers: { Authorization: `${token}` }
        });
        console.log(`Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹ÙˆÙ† Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionName} (${sectionId}):`, studentsResponse.data);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø±ØªØ¨Ø·ÙˆÙ† Ø¨Ø§Ù„Ø´Ø¹Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        const filteredStudents = studentsResponse.data.filter(student => {
          const studentSectionId = student.sectionId?._id || student.sectionId;
          return studentSectionId.toString() === sectionId.toString();
        });
        console.log(`Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØµÙÙˆÙ† Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionName} (${sectionId}):`, filteredStudents);

        const gradesResponse = await axios.get(`http://localhost:3000/grades?sectionId=${sectionId}&subjectId=${subjectId}`, {
          headers: { Authorization: `${token}` }
        });
        console.log(`Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø© Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionName} (${sectionId}) ÙˆØ§Ù„Ù…Ø§Ø¯Ø© ${subjectId}:`, gradesResponse.data);

        const filteredGrades = gradesResponse.data.filter(grade =>
          grade.sectionId.toString() === sectionId &&
          grade.subjectId.toString() === subjectId
        );

        return { students: filteredStudents, grades: filteredGrades };
      } catch (error) {
        console.error(`ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionId}:`, error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨', confirmButtonColor: '#1e3a8a' });
        return { students: [], grades: [] };
      }
    }

    function getMaxGrade(sectionId, term) {
      const section = allSections.find(s => s._id === sectionId);
      if (!section) {
        console.error(`Ø§Ù„Ø´Ø¹Ø¨Ø© ${sectionId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ allSections`);
        return 25; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¢Ù…Ù†Ø©
      }
      const classObj = allClasses.find(c => c._id === (section.classId?._id || section.classId));
      if (!classObj) {
        console.error(`Ø§Ù„ØµÙ Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ allClasses`);
        return 25; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¢Ù…Ù†Ø©
      }
      const className = classObj.name || '';
      console.log(`Ø§Ù„ØµÙ Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionId}: ${className}, Ø§Ù„ØªÙ‚ÙˆÙŠÙ…: ${term}`);

      if (['Ø§Ù„Ø£ÙˆÙ„', 'Ø§Ù„Ø«Ø§Ù†ÙŠ', 'Ø§Ù„Ø«Ø§Ù„Ø«'].includes(className)) {
        console.log(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙ ${className} Ù‡Ùˆ 25`);
        return 25;
      } else if (['Ø§Ù„Ø±Ø§Ø¨Ø¹', 'Ø§Ù„Ø®Ø§Ù…Ø³', 'Ø§Ù„Ø³Ø§Ø¯Ø³'].includes(className)) {
        const max = term === 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ' ? 40 : 20;
        console.log(`Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµÙ ${className} ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ… ${term} Ù‡Ùˆ ${max}`);
        return max;
      }
      console.warn(`Ø§Ù„ØµÙ ${className} ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØŒ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 25`);
      return 25; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¢Ù…Ù†Ø©
    }

    function calculateTotal(grades, studentId) {
      return terms.reduce((sum, term) => {
        const key = `${studentId}-${term}`;
        const grade = parseFloat(grades[key]?.grade || 0);
        return sum + (isNaN(grade) ? 0 : grade);
      }, 0);
    }

    function setupTeacherGrades(teacher) {
      const welcomeElement = document.getElementById('welcomeMessage');
      if (welcomeElement) {
        welcomeElement.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${teacher.name}!`;
      } else {
        console.error('Ø¹Ù†ØµØ± welcomeMessage ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
      }

      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ sectionIds Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ sectionId
      const sectionIds = [...new Set(
        teacherSubjectSections.map(tss => {
          return typeof tss.sectionId === 'object' ? tss.sectionId._id : tss.sectionId;
        })
      )];

      console.log('Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø´Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:', sectionIds);
      if (sectionIds.length === 0) {
        console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙŠ TeacherSubjectSections');
        Swal.fire({ icon: 'warning', title: 'ØªØ­Ø°ÙŠØ±', text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ùƒ', confirmButtonColor: '#1e3a8a' });
        const sectionsList = document.getElementById('sectionsList');
        if (sectionsList) {
          sectionsList.innerHTML = `
            <tr>
              <td colspan="4" class="p-3 text-center text-gray-700">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ùƒ</td>
            </tr>
          `;
        }
        return;
      }
      loadSections(sectionIds);
    }

    async function loadSections(sectionIds) {
      try {
        console.log('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø¨ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª:', sectionIds);
        await Promise.all([
          fetchSections(sectionIds),
          fetchClasses(),
          fetchSemesters(),
          fetchAcademicYears(),
          fetchSubjects()
        ]);

        const filteredSections = allSections.filter(section => {
          const sectionIdStr = section._id.toString(); // ØªØ£ÙƒØ¯ Ø£Ù†Ù‡ string

          return teacherSubjectSections.some(tss => {
            const tssSectionId = typeof tss.sectionId === 'object' && tss.sectionId !== null
              ? tss.sectionId._id?.toString()
              : tss.sectionId?.toString();
            return tssSectionId === sectionIdStr;
          });
        });

        const sectionsList = document.getElementById('sectionsList');
        if (!sectionsList) {
          console.error('Ø¹Ù†ØµØ± sectionsList ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
          return;
        }

        if (filteredSections.length === 0) {
          console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶');
          sectionsList.innerHTML = `
            <tr>
              <td colspan="4" class="p-3 text-center text-gray-700">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø¹Ø¨ Ù…ØªØ§Ø­Ø© (ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø´Ø¹Ø¨)</td>
            </tr>
          `;
          return;
        }

        const html = filteredSections.map(section => {
          const className = allClasses.find(c => c._id === (section.classId?._id || section.classId))?.name || '--';
          const semesterName = allSemesters.find(s => s._id === (section.semesterId?._id || section.semesterId))?.name || '--';
          const academicYearName = allAcademicYears.find(ay => ay._id === (section.academicYearId?._id || section.academicYearId))?.year || '--';
          return `
    <tr class="border-b cursor-pointer hover:bg-gray-100" 
        onclick="loadSubjects('${section._id}', '${section.name}')">
      <td class="p-3 text-gray-700">${section.name}</td>
      <td class="p-3 text-gray-700">${className}</td>
      <td class="p-3 text-gray-700">${semesterName}</td>
      <td class="p-3 text-gray-700">${academicYearName}</td>
    </tr>
  `;
        }).join('');
        sectionsList.innerHTML = html;
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø¹Ø¨', confirmButtonColor: '#1e3a8a' });
      }
    }

    function loadSubjects(sectionId, sectionName) {
      const section = allSections.find(s => s._id === sectionId);
      if (!section) {
        console.error('Ø§Ù„Ø´Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©:', sectionId);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'Ø§Ù„Ø´Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', confirmButtonColor: '#1e3a8a' });
        return;
      }

      const filteredSubjectIds = teacherSubjectSections
        .filter(tss => {
          const secId = typeof tss.sectionId === 'object' ? tss.sectionId._id : tss.sectionId;
          return secId === sectionId;
        })
        .map(tss => typeof tss.subjectId === 'object' ? tss.subjectId._id : tss.subjectId);
      console.log('Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØµÙ†ÙØ© Ù„Ù„Ø´Ø¹Ø¨Ø©:', sectionId, filteredSubjectIds);
      const filteredSubjects = allSubjects.filter(sub => filteredSubjectIds.includes(sub._id.toString()));

      if (filteredSubjects.length === 0) {
        console.warn('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø´Ø¹Ø¨Ø©:', sectionId);
        Swal.fire({ icon: 'warning', title: 'ØªØ­Ø°ÙŠØ±', text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©', confirmButtonColor: '#1e3a8a' });
        document.getElementáº¤nd('subjectsSection').classList.add('hidden');
        return;
      }

      const subjectsTitle = document.getElementById('subjectsTitle');
      if (subjectsTitle) {
        subjectsTitle.textContent = `Ø§Ù„Ù…ÙˆØ§Ø¯ - ${sectionName}`;
      } else {
        console.error('Ø¹Ù†ØµØ± subjectsTitle ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
      }

      const subjectsSection = document.getElementById('subjectsSection');
      const studentsSection = document.getElementById('studentsSection');
      if (subjectsSection && studentsSection) {
        subjectsSection.classList.remove('hidden');
        studentsSection.classList.add('hidden');
      } else {
        console.error('Ø¹Ù†ØµØ± subjectsSection Ø£Ùˆ studentsSection ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
      }

      const subjectsList = document.getElementById('subjectsList');
      if (subjectsList) {
        const html = filteredSubjects.map(subject => `
          <div class="bg-gray-100 p-4 rounded-lg cursor-pointer hover:bg-gray-200 transition-all" 
               onclick="loadStudents('${sectionId}', '${sectionName}', '${subject._id}', '${subject.name}')">
            <h3 class="font-semibold">${subject.name}</h3>
          </div>
        `).join('');
        subjectsList.innerHTML = html;
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯:', filteredSubjects);
      } else {
        console.error('Ø¹Ù†ØµØ± subjectsList ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
      }
    }

    async function loadStudents(sectionId, sectionName, subjectId, subjectName) {
      console.log(`ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø´Ø¹Ø¨Ø©: ${sectionId} (${sectionName}), Ø§Ù„Ù…Ø§Ø¯Ø©: ${subjectId} (${subjectName})`);
      const studentsTitle = document.getElementById('studentsTitle');
      if (studentsTitle) {
        studentsTitle.textContent = `Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø§Ù„Ø´Ø¹Ø¨Ø© ${sectionName} - ${subjectName}`;
      } else {
        console.error('Ø¹Ù†ØµØ± studentsTitle ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
      }

      const studentsSection = document.getElementById('studentsSection');
      if (studentsSection) {
        studentsSection.classList.remove('hidden');
      } else {
        console.error('Ø¹Ù†ØµØ± studentsSection ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
      }

      const { students, grades } = await fetchStudentsBySection(sectionId, subjectId);

      if (!students.length) {
        console.warn(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø´Ø¹Ø¨Ø© ${sectionName} (${sectionId})`);
        Swal.fire({
          icon: 'warning',
          title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨',
          text: `Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø´Ø¹Ø¨Ø© ${sectionName}`,
          confirmButtonColor: '#1e3a8a'
        });
        const studentsList = document.getElementById('studentsList');
        if (studentsList) {
          studentsList.innerHTML = `
            <tr>
              <td colspan="7" class="p-3 text-center text-gray-700">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø¹Ø¨Ø©</td>
            </tr>
          `;
        }
        return;
      }

      renderStudents(students, sectionId, subjectId, grades, sectionName, subjectName);
    }

    async function renderStudents(students, sectionId, subjectId, grades, sectionName, subjectName) {
      const studentsList = document.getElementById('studentsList');
      if (!studentsList) {
        console.error('Ø¹Ù†ØµØ± studentsList ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
        return;
      }

      console.log(`Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø´Ø¹Ø¨Ø© ${sectionName} (${sectionId}):`, students);

      let html = '';
      const gradeMap = grades.reduce((map, grade) => {
        if (grade.subjectId.toString() === subjectId) {
          map[`${grade.studentId}-${grade.term}`] = grade;
        }
        return map;
      }, {});

      for (const student of students) {
        let row = `<tr class="border-b" id="row-${student._id}">`;
        row += `<td class="p-3 text-gray-700">${student.name}</td>`;

        const gradeInputs = {};
        for (const term of terms) {
          const key = `${student._id}-${term}`;
          const grade = gradeMap[key] || { grade: '', _id: '' };
          const gradeValue = grade.grade || '';
          const gradeId = grade._id || '';
          const inputId = `grade-${student._id}-${term.replace(/\s/g, '-')}-${sectionId}-${subjectId}`;
          const maxGrade = getMaxGrade(sectionId, term);
          gradeInputs[term] = { inputId, gradeId, originalValue: gradeValue, sectionId, subjectId, maxGrade };
          row += `
            <td class="p-3 text-gray-700">
              <input type="number" min="0" max="${maxGrade}" value="${gradeValue}" 
                     class="w-20 p-1 border rounded-lg" 
                     id="${inputId}" disabled>
            </td>
          `;
        }

        const total = calculateTotal(gradeMap, student._id);
        row += `
          <td class="p-3 text-gray-700">
            <input type="number" value="${total}" class="w-20 p-1 border rounded-lg bg-gray-100" 
                   id="total-${student._id}-${sectionId}-${subjectId}" readonly>
          </td>`;

        row += `
          <td class="p-3">
            <div id="actions-${student._id}">
              <button onclick="enableEditing('${student._id}', '${sectionId}', '${subjectId}', '${sectionName}', '${subjectName}')"
                      class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600">
                ØªØ¹Ø¯ÙŠÙ„
              </button>
            </div>
          </td>`;
        row += `</tr>`;
        html += row;
      }

      studentsList.innerHTML = html;
    }

    async function enableEditing(studentId, sectionId, subjectId, sectionName, subjectName) {
      console.log(`ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentId}`);
      if (editingRow && editingRow !== studentId) {
        Swal.fire({
          icon: 'warning',
          title: 'ØªØ­Ø°ÙŠØ±',
          text: 'ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹',
          confirmButtonColor: '#1e3a8a'
        });
        return;
      }

      editingRow = studentId;
      originalGrades[studentId] = {};

      const { students, grades } = await fetchStudentsBySection(sectionId, subjectId);
      const student = students.find(s => s._id === studentId);
      if (!student) {
        console.error(`Ø§Ù„Ø·Ø§Ù„Ø¨ ${studentId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', confirmButtonColor: '#1e3a8a' });
        editingRow = null;
        return;
      }

      const gradeMap = grades.reduce((map, grade) => {
        if (grade.subjectId.toString() === subjectId) {
          map[`${grade.studentId}-${grade.term}`] = grade;
        }
        return map;
      }, {});

      for (const term of terms) {
        const key = `${studentId}-${term}`;
        const grade = gradeMap[key] || { grade: '', _id: '' };
        const gradeValue = grade.grade || '';
        const inputId = `grade-${studentId}-${term.replace(/\s/g, '-')}-${sectionId}-${subjectId}`;
        const maxGrade = getMaxGrade(sectionId, term);
        const input = document.getElementById(inputId);
        if (input) {
          originalGrades[studentId][term] = input.value;
          input.disabled = false;
          input.setAttribute('max', maxGrade);
          input.addEventListener('input', () => updateTotal(studentId, sectionId, subjectId));
        } else {
          console.error(`Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ${inputId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
        }
      }

      const actionsDiv = document.getElementById(`actions-${studentId}`);
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <button onclick="saveRowGrades('${studentId}', '${sectionId}', '${subjectId}')"
                  class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 mr-2">
            Ø­ÙØ¸
          </button>
          <button onclick="cancelEditing('${studentId}', '${sectionId}', '${subjectId}')"
                  class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">
            Ø¥Ù„ØºØ§Ø¡
          </button>
        `;
        console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentId}`);
      } else {
        console.error(`Ø¹Ù†ØµØ± actions-${studentId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
      }
    }

    function updateTotal(studentId, sectionId, subjectId) {
      let total = 0;
      terms.forEach(term => {
        const inputId = `grade-${studentId}-${term.replace(/\s/g, '-')}-${sectionId}-${subjectId}`;
        const input = document.getElementById(inputId);
        if (input) {
          const value = parseFloat(input.value) || 0;
          total += value;
        }
      });
      const totalInput = document.getElementById(`total-${studentId}-${sectionId}-${subjectId}`);
      if (totalInput) {
        totalInput.value = total;
      }
    }

    async function saveRowGrades(studentId, sectionId, subjectId) {
      console.log(`Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentId}, Ø§Ù„Ø´Ø¹Ø¨Ø© ${sectionId}, Ø§Ù„Ù…Ø§Ø¯Ø© ${subjectId}`);
      try {
        if (!/^[0-9a-fA-F]{24}$/.test(studentId) ||
          !/^[0-9a-fA-F]{24}$/.test(sectionId) ||
          !/^[0-9a-fA-F]{24}$/.test(subjectId)) {
          throw new Error('Ù…Ø¹Ø±Ù ØºÙŠØ± ØµØ§Ù„Ø­: studentId, sectionId, Ø£Ùˆ subjectId');
        }

        const { grades } = await fetchStudentsBySection(sectionId, subjectId);
        const gradeMap = grades.reduce((map, grade) => {
          if (grade.subjectId.toString() === subjectId) {
            map[`${grade.studentId}-${grade.term}`] = grade;
          }
          return map;
        }, {});

        for (const term of terms) {
          const inputId = `grade-${studentId}-${term.replace(/\s/g, '-')}-${sectionId}-${subjectId}`;
          const input = document.getElementById(inputId);
          if (!input) {
            console.error(`Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ${inputId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
            continue;
          }
          const grade = parseFloat(input.value);
          const maxGrade = getMaxGrade(sectionId, term);

          if (!isNaN(grade) && (grade < 0 || grade > maxGrade)) {
            Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: `Ø¹Ù„Ø§Ù…Ø© ${term} ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ${maxGrade}`, confirmButtonColor: '#1e3a8a' });
            return;
          }

          const key = `${studentId}-${term}`;
          const existingGrade = gradeMap[key] || { _id: '' };

          if (!isNaN(grade) && grade !== '') {
            if (existingGrade._id) {
              await axios.put(`http://localhost:3000/grades/update/${existingGrade._id}`, {
                grade: parseInt(grade)
              }, { headers: { Authorization: `${token}` } });
              console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø©: gradeId=${existingGrade._id}, grade=${grade}`);
            } else {
              const teacherResponse = await axios.get('http://localhost:3000/teacher/me', { headers: { Authorization: `${token}` } });
              const response = await axios.post('http://localhost:3000/grades/create', {
                studentId,
                sectionId,
                subjectId,
                term,
                grade: parseInt(grade),
                teacherId: teacherResponse.data._id
              }, { headers: { Authorization: `${token}` } });
              console.log(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©: studentId=${studentId}, term=${term}, grade=${grade}`);
            }
          }
        }

        disableEditing(studentId, sectionId, subjectId);
        Swal.fire({ icon: 'success', title: 'ØªÙ…', text: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', confirmButtonColor: '#1e3a8a' });
        const section = allSections.find(s => s._id === sectionId);
        const subject = allSubjects.find(s => s._id === subjectId);
        if (section && subject) {
          loadStudents(sectionId, section.name, subjectId, subject.name);
        } else {
          console.error('Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
          Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£Ùˆ Ø§Ù„Ù…Ø§Ø¯Ø©', confirmButtonColor: '#1e3a8a' });
        }
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª:', error.response?.data || error.message);
        Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª', confirmButtonColor: '#1e3a8a' });
      }
    }

    function cancelEditing(studentId, sectionId, subjectId) {
      console.log(`Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentId}`);
      for (const term of terms) {
        const inputId = `grade-${studentId}-${term.replace(/\s/g, '-')}-${sectionId}-${subjectId}`;
        const input = document.getElementById(inputId);
        if (input && originalGrades[studentId] && originalGrades[studentId][term]) {
          input.value = originalGrades[studentId][term];
          input.disabled = true;
        } else {
          console.error(`Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ${inputId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ø£ØµÙ„ÙŠØ©`);
        }
      }

      updateTotal(studentId, sectionId, subjectId);

      const actionsDiv = document.getElementById(`actions-${studentId}`);
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <button onclick="enableEditing('${studentId}', '${sectionId}', '${subjectId}', '${allSections.find(s => s._id === sectionId)?.name || ''}', '${allSubjects.find(s => s._id === subjectId)?.name || ''}')"
                  class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600">
            ØªØ¹Ø¯ÙŠÙ„
          </button>
        `;
        console.log(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentId}`);
      } else {
        console.error(`Ø¹Ù†ØµØ± actions-${studentId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
      }

      editingRow = null;
      delete originalGrades[studentId];
    }

    function disableEditing(studentId, sectionId, subjectId) {
      console.log(`ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentId}`);
      for (const term of terms) {
        const inputId = `grade-${studentId}-${term.replace(/\s/g, '-')}-${sectionId}-${subjectId}`;
        const input = document.getElementById(inputId);
        if (input) {
          input.disabled = true;
          const maxGrade = getMaxGrade(sectionId, term);
          input.setAttribute('max', maxGrade);
        } else {
          console.error(`Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ${inputId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
        }
      }

      const actionsDiv = document.getElementById(`actions-${studentId}`);
      if (actionsDiv) {
        actionsDiv.innerHTML = `
          <button onclick="enableEditing('${studentId}', '${sectionId}', '${subjectId}', '${allSections.find(s => s._id === sectionId)?.name || ''}', '${allSubjects.find(s => s._id === subjectId)?.name || ''}')"
                  class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600">
            ØªØ¹Ø¯ÙŠÙ„
          </button>
        `;
      } else {
        console.error(`Ø¹Ù†ØµØ± actions-${studentId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
      }

      editingRow = null;
      delete originalGrades[studentId];
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'index.html';
    }

    function handleAuthError(error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆØ«ÙŠÙ‚:', error.response?.data || error.message);
      if (error.response?.status === 401) {
        Swal.fire({
          icon: 'error',
          title: 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©',
          text: 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
          confirmButtonColor: '#1e3a8a'
        }).then(() => logout());
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Ø®Ø·Ø£',
          text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (error.response?.data?.message || error.message),
          confirmButtonColor: '#1e3a8a'
        });
      }
    }

    fetchTeacherData();
  </script>
</body>

</html>